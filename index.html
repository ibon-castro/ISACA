<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ISACA</title>
  <!-- Link to external CSS -->
  <link rel="stylesheet" href="css/styles.css">
  <!-- Vue.js -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
</head>
<body>
  <div id="app">
    <!-- Disclaimer -->
    <p class="disclaimer">
      ⚠️ Esto no es un CTF. Por favor, no intentéis tirar la web. Cualquier mal uso implicará la cancelación de la invitación.
    </p>

    <!-- Navigation Tabs (Reversed Order) -->
    <div class="tabs">
      <button :class="{active: currentTab==='talks'}" @click="currentTab='talks'">Asistencia</button>
      <button :class="{active: currentTab==='register'}" @click="currentTab='register'">Registro</button>
    </div>

    <!-- Registration Form -->
    <div v-if="currentTab === 'register'" class="form-container" :class="{ active: currentTab === 'register' }">
      <img src="img/ISACA_logo.png" alt="ISACA Logo" class="form-logo">

      <!-- Invitation Message -->
      <div class="invitation-message">
        <p><strong>ISACA Madrid te invita a unas pizzas.</strong> Para poder unirte, solo necesitas cumplir con los siguientes requisitos:</p>
        <ul>
          <li>Registrarte (solo una vez)</li>
          <li>Asistir a un mínimo de tres charlas de nuestro track y registrar tu asistencia con cada QR.</li>
        </ul>
      </div>

      <h2>Registro</h2>
      <form @submit.prevent="submitRegistration">
        <div class="form-group">
          <label for="name">Nombre:</label>
          <input type="text" id="name" v-model="registration.name" required>
        </div>
        <div class="form-group">
          <label for="surnames">Apellidos:</label>
          <input type="text" id="surnames" v-model="registration.surnames" required>
        </div>
        <div class="form-group">
          <label for="age">Edad:</label>
          <input type="number" id="age" v-model="registration.age" min="0" required>
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" v-model="registration.isStudent">
            Soy estudiante
          </label>
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" v-model="registration.isacaMadrid">
            Soy miembro de ISACA Madrid
          </label>
        </div>
        <div class="form-group">
          <label for="email">Correo:</label>
          <input type="email" id="email" v-model="registration.email" required>
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" v-model="registration.acceptData">
            Acepto el procesamiento de mis datos
          </label>
        </div>
        <button type="submit">Registrarse</button>
      </form>
    </div>

    <!-- Talks Selection Form -->
    <div v-if="currentTab === 'talks'" class="form-container" :class="{ active: currentTab === 'talks' }">
      <img src="img/ISACA_logo.png" alt="ISACA Logo" class="form-logo">

      <!-- Invitation Message -->
      <div class="invitation-message">
        <p><strong>ISACA Madrid te invita a unas pizzas.</strong> Para poder unirte, solo necesitas cumplir con los siguientes requisitos:</p>
        <ul>
          <li>Registrarte (solo una vez)</li>
          <li>Asistir a un mínimo de tres charlas de nuestro track y registrar tu asistencia con cada QR.</li>
        </ul>
      </div>

      <h2>Asistencia</h2>
      <form @submit.prevent="submitTalks">
        <div class="form-group">
          <label for="talks-email">Correo:</label>
          <input type="email" id="talks-email" v-model="talks.email" @input="checkEmailExists" required>
          <p class="reminder">
            Regístrate en la pestaña "<a href="#" @click.prevent="currentTab='register'">Registro</a>" si aún no lo has hecho.
          </p>
        </div>

        <!-- Display the talk title if talk_id is provided -->
        <div class="form-group" v-if="selectedTalkTitle">
          <p class="talk-title">{{ selectedTalkTitle }}</p>
          <p class="talk-author">Autor: {{ selectedTalkAuthor }}</p>
          <!-- Hidden field to store the talk id -->
          <input type="hidden" v-model="talks.selectedTalk">
        </div>
        <!-- Fallback if no talk_id is provided -->
        <div class="form-group" v-else>
          <p class="error">No se ha especificado una charla en la URL.</p>
        </div>

        <button type="submit" :disabled="!talks.emailExists">He asistido</button>
      </form>
    </div>
  </div>

  <script type="module">
    import { db, collection, addDoc, query, where } from "./js/firebase.js";
  
    new Vue({
      el: "#app",
      data: {
        currentTab: "talks",
        registration: {
          name: "",
          surnames: "",
          age: null,
          isStudent: false,
          isacaMadrid: false,
          email: "",
          acceptData: false,
        },
        talks: {
          email: "",
          selectedTalk: "",
          emailExists: null,
        },
        talksList: [
          { id: 1, title: "From Theory to Reality: Implementing ISACA’s Digital Trust Framework", author: "Anass Abajtour" },
          { id: 2, title: "El auditor del futuro: Cómo la IA está transformando la profesión", author: "Rafael Troncoso, Pablo González, Pablo Rodríguez, Karla Torres, Águeda de Lara. Modera: José Miguel Cardona" },
          { id: 3, title: "Auditando Arquitecturas Software Empresariales", author: "Elías Grande" },
          { id: 4, title: "Active Directory: El eslabón crítico en la ciberseguridad corporativa", author: "Alex Amorín" },
          { id: 5, title: "Orchestrated Insecurity: Breaking Down Common Container Vulnerabilities", author: "Jose María Pulgar, Carlos Polop" },
          { id: 6, title: "LLM Security Audits 101: The Good, the Bad, and the Broken", author: "Javier del Pino" },
          { id: 7, title: "Ciberseguridad industrial: El reto de auditar sin interrumpir", author: "Erik de Pablo, Enrique Miranda, Ignacio García Egea, Manuel Ballesteros, Ander Galisteo. Modera: Juan José Nombela" },
          { id: 8, title: "Más allá del checkbox: Auditoría real de cumplimiento en la nueva era regulatoria", author: "Andrés Porras, Xavier Sanz i Vives, Guillermo Martín, María Cristina Bausa Rosa, Josune Charola. Modera: Juan Galdon" }
        ],
        selectedTalkTitle: "",
      },
      mounted() {
        const params = new URLSearchParams(window.location.search);
        const talkId = params.get("talk_id");
        if (talkId) {
          const id = parseInt(talkId);
          this.talks.selectedTalk = id;
  
          // Find the talk title and author
          const talk = this.talksList.find((t) => t.id === id);
          if (talk) {
            this.selectedTalkTitle = talk.title;
            this.selectedTalkAuthor = talk.author; // Store the author's name
          } else {
            this.selectedTalkTitle = "Charla no encontrada";
            this.selectedTalkAuthor = "";
          }
        }
      },
      methods: {
        async checkEmailExists() {
          if (!this.talks.email) {
            this.talks.emailExists = false;
            return;
          }

          try {
            const q = query(collection(db, "registrations"), where("email", "==", this.talks.email));
            const querySnapshot = await getDocs(q);
            
            this.talks.emailExists = !querySnapshot.empty;
          } catch (error) {
            console.error("Error checking email:", error);
            this.talks.emailExists = false; // Ensure it disables the button on error
          }
        },
        async submitRegistration() {
          if (!this.registration.acceptData) {
            alert("Debes aceptar el procesamiento de tus datos.");
            return;
          }
  
          try {
            await addDoc(collection(db, "registrations"), {
              name: this.registration.name,
              surnames: this.registration.surnames,
              age: this.registration.age,
              isStudent: this.registration.isStudent,
              isacaMadrid: this.registration.isacaMadrid,
              email: this.registration.email,
              acceptData: this.registration.acceptData,
            });
  
            alert("Registro terminado!");
            this.talks.email = this.registration.email;
            this.currentTab = "talks";
          } catch (error) {
            console.error("Error registrando usuario:", error);
            alert("Hubo un error al registrar. Intenta de nuevo.");
          }
        },
        async submitTalks() {
          // Ensure email is checked first
          await this.checkEmailExists();

          if (!this.talks.emailExists) {
            alert("Este correo no está registrado. Por favor, regístrate primero.");
            return;
          }

          try {
            await addDoc(collection(db, "attendance"), {
              email: this.talks.email,
              talkId: this.talks.selectedTalk,
              timestamp: new Date(),
            });

            alert("Asistencia registrada con éxito.");
          } catch (error) {
            alert("Hubo un error al registrar la asistencia. Intenta de nuevo.");
          }
        },
      },
    });
  </script>  

  <script type="module" src="js/firebase.js"></script>
</body>
</html>